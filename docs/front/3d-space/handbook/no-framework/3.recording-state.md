---
title: çŠ¶æ€å½•åˆ¶
---

> **ä¸Šä¸€ç« å›é¡¾: æ”¹å˜è§†è§’** <br/>
> - ä½ äº†è§£ä»€ä¹ˆæ˜¯ **State**, ä»¥åŠå¦‚ä½•è·å–å’Œä¿®æ”¹ã€‚<br/>
> - é€šè¿‡ **State** å®Œæˆäº†è‡ªåŠ¨ç¯è§†çš„åŠŸèƒ½ã€‚

:::tip æœ¬ç« ä½ å¯ä»¥å­¦ä¹ åˆ°

- é€šè¿‡ **State** å®Œæˆç”¨æˆ·æ“ä½œçš„å½•åˆ¶ã€‚
- é€šè¿‡ **State** è¿˜åŸç”¨æˆ·æ“ä½œç”»é¢ã€‚

:::

## å‡†å¤‡å·¥ä½œ

å’Œä¸Šä¸€ç« èŠ‚ä¸€æ ·ï¼Œæˆ‘ä»¬æ–°å»ºä¸€ä¸ªç›®å½•ï¼ˆ`src/3.recording-state`ï¼‰ä»¥åŠå¯¹åº”çš„ **html** æ–‡ä»¶ ä»¥åŠ **jsx** æˆ– **tsx** æ–‡ä»¶ã€‚

**js** æˆ– **ts** æ–‡ä»¶å¯ä»¥å…ˆæ‹·è´ä¸Šä¸€ç« èŠ‚çš„å†…å®¹ã€‚

```html title="src/3.recording-state/index.html"
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ”¹å˜è§†è§’ | Knowing state</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    html, body, #app { width: 100%; height: 100%; overflow: hidden; }
  </style>
</head>
<body>
  <div id="app"></div>
  <!-- æ¨¡å¼åˆ‡æ¢ -->
  <nav class="navbar fixed-bottom navbar-light bg-light">
    <div class="container-fluid justify-content-center">
      <div class="btn-group">
        <button class="btn btn-primary active js-Panorama">å…¨æ™¯æ¼«æ¸¸</button>
        <button class="btn btn-primary js-Floorplan">ç©ºé—´æ€»è§ˆ</button>
      </div>
    </div>
  </nav>
  <!-- ç¯è§† -->
  <div class="card position-fixed m-2 top-0 end-0">
    <button class="btn btn-light js-lookAround-start"><i class="bi bi-arrow-repeat"></i></button>
    <button class="btn btn-light js-lookAround-stop d-none"><i class="bi bi-pause"></i></button>
  </div>
  <script type="module" src="./index"></script>
</body>
</html>
```

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

<Tabs>
<TabItem value="JavaScript" label="JavaScript">

```js title="src/3.recording-state/index.js"
import { Five, parseWork } from "@realsee/five";

const workURL = "https://vrlab-public.ljcdn.com/release/static/image/release/five/work-sample/07bdc58f413bc5494f05c7cbb5cbdce4/work.json";

const five = new Five();

five.appendTo(document.querySelector("#app"));

fetch(workURL).then(res => res.json()).then((json) => {
  const work = parseWork(json);
  five.load(work);
});

window.addEventListener("resize", () => five.refresh(), false);

{// === æ¨¡å¼åˆ‡æ¢ ===
  const buttons = {
    "Panorama": document.querySelector(".js-Panorama"),
    "Floorplan": document.querySelector(".js-Floorplan")
  };

  for (const [modeName, element] of Object.entries(buttons)) {
    element.addEventListener("click", () => {
      five.setState({ mode: modeName });
    }, false);
  }

  five.on("stateChange", state => {
    for (const [modeName, element] of Object.entries(buttons)) {
      if (modeName === state.mode) {
        element.classList.add("active");
      } else {
        element.classList.remove("active");
      }
    };
  });
}

{ // === ç¯è§† ===
  let timer;
  const startButton = document.querySelector(".js-lookAround-start");
  const stopButton = document.querySelector(".js-lookAround-stop");
  startButton.addEventListener("click", () => {
    window.clearInterval(timer);
    timer = window.setInterval(() => {
      five.setState({ longitude: five.state.longitude + Math.PI / 360 })
    }, 16);
    startButton.classList.add("d-none");
    stopButton.classList.remove("d-none");
  }, false);
  stopButton.addEventListener("click", () => {
    window.clearInterval(timer);
    startButton.classList.remove("d-none");
    stopButton.classList.add("d-none");
  }, false);
}

export {};
```

</TabItem>
<TabItem value="TypeScript" label="TypeScript">

```ts title="src/3.recording-state/index.ts"
import { Five, Mode, parseWork } from "@realsee/five";

const workURL = "https://vrlab-public.ljcdn.com/release/static/image/release/five/work-sample/07bdc58f413bc5494f05c7cbb5cbdce4/work.json";

const five = new Five();

five.appendTo(document.querySelector("#app")!);

fetch(workURL).then(res => res.json()).then((json) => {
  const work = parseWork(json);
  five.load(work);
});

window.addEventListener("resize", () => five.refresh(), false);

{// === æ¨¡å¼åˆ‡æ¢ ===
  const buttons: Partial<Record<Mode, Element>> = {
    "Panorama": document.querySelector(".js-Panorama")!,
    "Floorplan": document.querySelector(".js-Floorplan")!
  };

  for (const [modeName, element] of Object.entries(buttons)) {
    element.addEventListener("click", () => {
      five.setState({ mode: modeName as Mode });
    }, false);
  }

  five.on("stateChange", state => {
    for (const [modeName, element] of Object.entries(buttons)) {
      if (modeName === state.mode) {
        element.classList.add("active");
      } else {
        element.classList.remove("active");
      }
    };
  });
}

{ // === ç¯è§† ===
  let timer: number | undefined;
  const startButton = document.querySelector(".js-lookAround-start")!;
  const stopButton = document.querySelector(".js-lookAround-stop")!;
  startButton.addEventListener("click", () => {
    window.clearInterval(timer);
    timer = window.setInterval(() => {
      five.setState({ longitude: five.state.longitude + Math.PI / 360 })
    }, 16);
    startButton.classList.add("d-none");
    stopButton.classList.remove("d-none");
  }, false);
  stopButton.addEventListener("click", () => {
    window.clearInterval(timer);
    startButton.classList.remove("d-none");
    stopButton.classList.add("d-none");
  }, false);
}

export {};
```

</TabItem>
</Tabs>


å¯åŠ¨æœåŠ¡ `npm run dev`ã€‚ å¹¶è·³è½¬åˆ°å½“å‰é¡µé¢ "http://localhost:3000/src/3.recording-state"ã€‚

:::tip
è¯·æŸ¥çœ‹ä½ çš„æ§åˆ¶å°ï¼Œç«¯å£å·ä¼šå› ä¸ºä½ çš„é…ç½®ä»¥åŠå½“å‰ç«¯å£å ç”¨æƒ…å†µå˜æ›´ï¼Œè¯·å·²æ§åˆ¶å°è¾“å‡ºçš„ä¸ºå‡†ã€‚  
å¦‚æœä½ ä½¿ç”¨å…¶ä»–å¼€å‘æ„å»ºå·¥å…·ï¼Œè¯·æŒ‰ç…§è‡ªå·±çš„å¼€å‘æ„å»ºå·¥å…·çš„è¦æ±‚å¯åŠ¨æœåŠ¡ã€‚
:::

## å½•åˆ¶ / å›æ”¾
> è¿™ç« æˆ‘ä»¬ç»§ç»­é€šè¿‡ **State** æ¥å®Œæˆä¸€ä¸ªæœ‰æ„æ€çš„åº”ç”¨ã€‚
æœ¬ç« æˆ‘ä»¬ä¼šå®Œæˆè¿™æ ·çš„ä¸€ä¸ªåº”ç”¨ï¼Œè®°å½•ç”¨æˆ·åœ¨é¡µé¢ä¸Šå‘ç”Ÿçš„ **State**ï¼Œå¹¶ä¸”å¯ä»¥å›æ”¾è¿™äº›æ“ä½œã€‚<br/>

### æ„å»º å½•åˆ¶åŠŸèƒ½ UI

æˆ‘ä»¬åœ¨é¡µé¢å·¦ä¸Šè§’æ·»åŠ  UI æŒ‰é’®ï¼Œæˆ‘ä»¬è®¾è®¡äº†ï¼š

- å¼€å§‹å½•åˆ¶æŒ‰é’®
- åœæ­¢å½•åˆ¶æŒ‰é’®
- å›æ”¾æŒ‰é’®

ä»¥åŠä¸¤ä¸ªçŠ¶æ€ï¼š

- å½•åˆ¶ä¸­
- å›æ”¾ä¸­

```html title="src/3.recording-state/index.html"
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>çŠ¶æ€å½•åˆ¶ | Recording state</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    html, body, #app { width: 100%; height: 100%; overflow: hidden; }
  </style>
</head>
<body>
  <div id="app"></div>
  <!-- æ¨¡å¼åˆ‡æ¢ -->
  <nav class="navbar fixed-bottom navbar-light bg-light">
    <div class="container-fluid justify-content-center">
      <div class="btn-group">
        <button class="btn btn-primary active js-Panorama">å…¨æ™¯æ¼«æ¸¸</button>
        <button class="btn btn-primary js-Floorplan">ç©ºé—´æ€»è§ˆ</button>
      </div>
    </div>
  </nav>
  <!-- ç¯è§† -->
  <div class="card position-fixed m-2 top-0 end-0">
    <button class="btn btn-light js-lookAround-start"><i class="bi bi-arrow-repeat"></i></button>
    <button class="btn btn-light js-lookAround-stop d-none"><i class="bi bi-pause"></i></button>
  </div>
  <!-- highlight-start -->
  <!-- å½•åˆ¶ -->
  <div class="card position-fixed m-2 top-0 start-0">
    <div class="btn-group align-items-center">
      <button class="btn btn-light js-recording-start"><i class="bi bi-record-fill"></i></button>
      <button class="btn btn-light js-recording-stop d-none"><i class="bi bi-stop-fill"></i></button>
      <button class="btn btn-light js-recording-play"><i class="bi bi-play-fill"></i></button>
      <p class="badge bg-primary m-2 js-state-recording d-none">å½•åˆ¶ä¸­</p>
      <p class="badge bg-primary m-2 js-state-playing d-none">æ’­æ”¾ä¸­</p>
    </div>
  </div>
  <!-- highlight-end -->
  <script type="module" src="./index"></script>
</body>
</html>
```

### ç¼–å†™ **Recorder** ç±»
é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ç¼–å†™ **Recorder** ç±»ï¼Œæ¥æ”¯æŒè®°å½•å’Œå›æ”¾ã€‚
**Recorder** ç±» å¹¶é **Five** çš„å†…å®¹ï¼Œåªæ˜¯ä¸ºäº†è¾¾æˆæœ¬ç« çš„æ•ˆæœç¼–å†™çš„ã€‚

1. å®ç° **startRecording / endRecording** æ–¹æ³•ï¼Œç”¨äºå¼€å§‹å½•åˆ¶å’Œç»“æŸå½•åˆ¶ï¼›
2. å®ç° **record(state: State)** æ–¹æ³•ï¼Œè®°å½•å½•åˆ¶å†…å®¹ã€‚è®°å½• **startRecording / endRecording** ä¹‹é—´çš„å†…å®¹ï¼›
3. å®ç° **play(callback)** æ–¹æ³•ï¼Œç”¨äºå›æ”¾ï¼Œè°ƒç”¨ play ä¹‹åï¼Œä¼šå®‰è£… **record** çš„å†…å®¹ï¼Œä¾æ¬¡è°ƒç”¨ **callback** æ–¹æ³•ï¼Œå›æ”¾ **State**ã€‚

<Tabs>
<TabItem value="JavaScript" label="JavaScript">

```js title="src/3.recording-state/recorder.js"
/**
 * å½•åˆ¶ç±»
 */
class Recorder {
  constructor() {
    this.startTime = 0;
    this.records = null;
  }
  /**
   * æ˜¯å¦å·²å½•åˆ¶
   */
  hasRecords() {
    return this.records !== null;
  }
  /**
   * å½•åˆ¶å…³é”®å¸§
   * @param state five çš„ state
   * @returns
   */
  record(state) {
    if (this.records === null) return;
    this.records.push({
      state: Object.assign({}, state),
      time: Date.now() - this.startTime
    });
  }
  /**
   * å¼€å§‹å½•åˆ¶
   */
  startRecording() {
    this.startTime = Date.now();
    this.records = [];
  }
  /**
   * ç»“æŸå½•åˆ¶
   */
  endRecording() {
    this.startTime = 0;
  }
  /**
   * å›æ”¾å½•åˆ¶
   * @param callback å…³é”®å¸§å›è°ƒ
   * @returns å½“å‰æ˜¯å¦æœ‰å½•åˆ¶
   */
  play(callback) {
    if (this.records === null || this.records.length === 0) return false;
    const records = this.records.slice();
    const keyframe = keyIndex => {
      const current = records[keyIndex];
      const next = records[keyIndex + 1];
      callback(current.state, next === undefined);
      if (next) {
        const delay = next.time - current.time;
        setTimeout(() => keyframe(keyIndex + 1), delay);
      }
    }
    keyframe(0);
    return true;
  }
}

export { Recorder };
```

</TabItem>
<TabItem value="TypeScript" label="TypeScript">

```ts title="src/3.recording-state/recorder.ts"
import { State } from "@realsee/five";

/**
 * å½•åˆ¶ç±»
 */
class Recorder {
  private records: { state: State, time: number }[] | null = null;
  private startTime: number;
  constructor() {
    this.startTime = 0;
    this.records = null;
  }
  /**
   * æ˜¯å¦å·²å½•åˆ¶
   */
  hasRecords() {
    return this.records !== null;
  }
  /**
   * å½•åˆ¶å…³é”®å¸§
   * @param state five çš„ state
   * @returns
   */
  record(state: State) {
    if (this.records === null) return;
    this.records.push({
      state: Object.assign({}, state),
      time: Date.now() - this.startTime
    });
  }
  /**
   * å¼€å§‹å½•åˆ¶
   */
  startRecording() {
    this.startTime = Date.now();
    this.records = [];
  }
  /**
   * ç»“æŸå½•åˆ¶
   */
  endRecording() {
    this.startTime = 0;
  }
  /**
   * å›æ”¾å½•åˆ¶
   * @param callback å…³é”®å¸§å›è°ƒ
   * @returns å½“å‰æ˜¯å¦æœ‰å½•åˆ¶
   */
  play(callback: (state: State, isFinal: boolean) => void) {
    if (this.records === null || this.records.length === 0) return false;
    const records = this.records.slice();
    const keyframe = (keyIndex: number) => {
      const current = records[keyIndex];
      const next = records[keyIndex + 1];
      callback(current.state, next === undefined);
      if (next) {
        const delay = next.time - current.time;
        setTimeout(() => keyframe(keyIndex + 1), delay);
      }
    }
    keyframe(0);
    return true;
  }
}

export { Recorder };
```

</TabItem>
</Tabs>


### ç¼–å†™å½•åˆ¶é€»è¾‘

åœ¨ä¸Šä¸€ç« çš„ **ç¯è§†** çš„ä»£ç åè¿½åŠ ï¼š

<Tabs>
<TabItem value="JavaScript" label="JavaScript">

```js title="src/3.recording-state/index.js"
{ //=== å½•åˆ¶ ===
  const recorder = new Recorder();
  const startRecordingButton = document.querySelector(".js-recording-start");
  const stopRecordingButton = document.querySelector(".js-recording-stop");
  const playRecordingButton = document.querySelector(".js-recording-play");
  const recordingState = document.querySelector(".js-state-recording");
  const playingState = document.querySelector(".js-state-playing");

  five.on("stateChange", state => {
    if (recordingState.classList.contains("d-none")) return;
    recorder.record(state);
  });

  startRecordingButton.addEventListener("click", () => {
    recorder.startRecording();
    startRecordingButton.classList.add("d-none");
    stopRecordingButton.classList.remove("d-none");
    playRecordingButton.classList.add("d-none");
    recordingState.classList.remove("d-none");
    playingState.classList.add("d-none");
  }, false);

  stopRecordingButton.addEventListener("click", () => {
    recorder.endRecording();
    startRecordingButton.classList.remove("d-none");
    stopRecordingButton.classList.add("d-none");
    playRecordingButton.classList.remove("d-none");
    recordingState.classList.add("d-none");
    playingState.classList.add("d-none");
  }, false);

  playRecordingButton.addEventListener("click", () => {
    const hasReocrd = recorder.play((state, isFinal) => {
      five.setState(state);
      if (isFinal) {
        startRecordingButton.classList.remove("d-none");
        stopRecordingButton.classList.add("d-none");
        playRecordingButton.classList.remove("d-none");
        recordingState.classList.add("d-none");
        playingState.classList.add("d-none");
      }
    });
    if (hasReocrd) {
      startRecordingButton.classList.add("d-none");
      stopRecordingButton.classList.add("d-none");
      playRecordingButton.classList.add("d-none");
      recordingState.classList.add("d-none");
      playingState.classList.remove("d-none");
    }
  }, false);
}
```

</TabItem>
<TabItem value="TypeScript" label="TypeScript">

```ts title="src/3.recording-state/index.ts"
{ //=== å½•åˆ¶ ===
  const recorder = new Recorder();
  const startRecordingButton = document.querySelector(".js-recording-start")!;
  const stopRecordingButton = document.querySelector(".js-recording-stop")!;
  const playRecordingButton = document.querySelector(".js-recording-play")!;
  const recordingState = document.querySelector(".js-state-recording")!;
  const playingState = document.querySelector(".js-state-playing")!;

  five.on("stateChange", state => {
    if (recordingState.classList.contains("d-none")) return;
    recorder.record(state);
  });

  startRecordingButton.addEventListener("click", () => {
    recorder.startRecording();
    startRecordingButton.classList.add("d-none");
    stopRecordingButton.classList.remove("d-none");
    playRecordingButton.classList.add("d-none");
    recordingState.classList.remove("d-none");
    playingState.classList.add("d-none");
  }, false);

  stopRecordingButton.addEventListener("click", () => {
    recorder.endRecording();
    startRecordingButton.classList.remove("d-none");
    stopRecordingButton.classList.add("d-none");
    playRecordingButton.classList.remove("d-none");
    recordingState.classList.add("d-none");
    playingState.classList.add("d-none");
  }, false);

  playRecordingButton.addEventListener("click", () => {
    const hasReocrd = recorder.play((state, isFinal) => {
      five.setState(state);
      if (isFinal) {
        startRecordingButton.classList.remove("d-none");
        stopRecordingButton.classList.add("d-none");
        playRecordingButton.classList.remove("d-none");
        recordingState.classList.add("d-none");
        playingState.classList.add("d-none");
      }
    });
    if (hasReocrd) {
      startRecordingButton.classList.add("d-none");
      stopRecordingButton.classList.add("d-none");
      playRecordingButton.classList.add("d-none");
      recordingState.classList.add("d-none");
      playingState.classList.remove("d-none");
    }
  }, false);
}
```

</TabItem>
</Tabs>


å›åˆ°ä½ çš„æµè§ˆå™¨æŸ¥çœ‹ï¼Œä¼šå‘ç°ä½ çš„é¡µé¢å·¦ä¸Šè§’å‡ºç°ä¸€ä¸ªå½•åˆ¶å’Œæ’­æ”¾æŒ‰é’®ã€‚è¯•è¯•åŠŸèƒ½æ˜¯ä¸æ˜¯ç¬¦åˆé¢„æœŸã€‚

çœŸå‰å®³ï¼Œä½ ä»¥åŠå¯ä»¥ç¼–å†™é‚£ä¹ˆå¤æ‚çš„ç¨‹åºäº†ğŸ¥³ ã€‚

## ä¸‹ä¸€ç« èŠ‚ä½ ä¼šå­¦åˆ°

:::tip ä¸‹ä¸€ç« æˆ‘ä»¬éœ€è¦å’Œä¸‰ç»´ç©ºé—´çš„æ¨¡å‹æ‰“äº¤é“äº†

- äº†è§£ Five SDK çš„æ‰‹åŠ¿äº¤äº’ç³»ç»Ÿã€‚
- è·å–åˆ°ç‚¹çš„ä¸‰ç»´ä½ç½®ã€‚

:::
